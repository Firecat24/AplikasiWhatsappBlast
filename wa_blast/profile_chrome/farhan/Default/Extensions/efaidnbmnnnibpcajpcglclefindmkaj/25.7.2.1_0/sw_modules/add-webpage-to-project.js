/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{analytics as e}from"../common/analytics.js";import{dcLocalStorage as t}from"../common/local-storage.js";import{loggingApi as r}from"../common/loggingApi.js";import{common as o}from"./common.js";import a from"./ExplicitBlocklist.js";import{floodgate as n}from"./floodgate.js";import{createPerfTracker as s,PERF_MARKERS as c}from"./perf-tracker.js";import{cleanupUsedOrExpiredRequests as i,registerRequestId as m}from"./request-validator.js";import{util as d}from"./util.js";const l=["http://*/*","https://*/*"];let u=!1;const g=new Map,p=function(){const e="abcdefghijklmnopqrstuvwxyz0123456789.-",t={};for(let r=0;r<38;r++)t[e[r]]="tubg6lxdq8jc1m9-vw.pfhskar0oi5zn372ye4"[r];return t}(),f=["documentcloud.adobe.com","acrobat.adobe.com","stage.acrobat.adobe.com","dev.acrobat.adobe.com"];async function b({url:e,domain:t}){if(!e&&!t)return!1;try{if(t||(t=new URL(e).hostname),f.includes(t))return!0;const[r=[],o=[]]=await Promise.all([a.getKWBlockList(),a.getExplicitBlocklist()]);return!![...r,...o].includes(function(e){return e.toLowerCase().split("").map((e=>p[e]||e)).join("")}(t))}catch(e){return r.error({message:"Error in checking for blocked domain",error:e?.message}),!1}}function h(){!function(){const e=Date.now();g.forEach(((t,r)=>{e-(t?.getStartTime?.()||0)>36e5&&g.delete(r)}))}(),i()}async function E(){await t.init();if(!await n.hasFlag("dc-cv-add-webpage-to-project"))return!1;const e="false"!==t.getItem("egaf"),o="true"===t.getItem("DISABLE_GENAI_BY_ADMIN"),a=t.getItem("appLocale")||chrome.i18n.getMessage("@@ui_locale"),s=n.getFeatureMeta("dc-cv-add-webpage-to-project");let c=["en-US","en-GB"];if(s)try{const e=JSON.parse(s);e.allowedLocales&&(c=e.allowedLocales)}catch(e){r.error({message:"Error parsing AddWebpageToProject flag metadata",error:e?.message})}const i=c.includes(a)||a.startsWith("en");return!(!e||o||!i)}async function _(){const e=await E();try{e?u||(chrome.contextMenus.create({id:"addWebpageToProject",title:d.getTranslation("addWebpageToProjectContextMenuTitle"),contexts:["page"],documentUrlPatterns:l}),u=!0):u&&(chrome.contextMenus.remove("addWebpageToProject"),u=!1)}catch(e){r.error({message:"Error creating AddWebpageToProject context menu",error:e?.message})}}function I(e){if(document.getElementById("addWebpageToProjectExtnIframe"))return;const{env:t,tabId:r,locale:o,requestId:a,context:n}=e,s=(e,t={})=>{const r={main_op:"kw-perf-mark",data:{requestId:a,name:e,metadata:t,timestamp:Date.now()}};chrome.runtime.sendMessage(r)};s("AWPP_Extension_Iframe_Creation_Started");const c=document.createElement("iframe"),i=chrome.runtime.getURL("resources/addWebpage/index.html"),m=new URL(i);m.searchParams.set("env",t),m.searchParams.set("tabId",r),m.searchParams.set("locale",o),m.searchParams.set("requestId",a),m.searchParams.set("context",n),c.src=m.toString(),c.id="addWebpageToProjectExtnIframe",c.allowFullscreen=!0,document.body.style.overflow="hidden",c.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        border: none;\n        z-index: 10000;\n        background: rgba(0, 0, 0, 0.1);\n        color-scheme: light;\n    ",c.onload=()=>{s("AWPP_Extension_Iframe_Loaded")},c.onerror=()=>{s("AWPP_Extension_Iframe_Error"),u()},document.body.appendChild(c),s("AWPP_Extension_Iframe_Added_To_Document");const d=new URL(chrome.runtime.getURL("resources/addWebpage/index.html")).origin,l=e=>{if(e.origin!==d)return;const{main_op:t}=e.data;switch(t){case"closeAllIframes":u();break;case"openCollectionTab":chrome.runtime.sendMessage({main_op:"openCollectionTab",data:e.data},(e=>{e.closeDialog&&u()}));break;case"kw-perf-mark":const{main_op:t,...r}=e.data;chrome.runtime.sendMessage({main_op:t,data:r})}},u=()=>{const e=document.getElementById("addWebpageToProjectExtnIframe");e&&(s("AWPP_Extension_Iframe_Removed"),document.body.style.overflow="auto",chrome.runtime.sendMessage({main_op:"emit-perf-data",data:{requestId:a}}),window.removeEventListener("message",l),e.style.display="none",setTimeout((()=>{document.body.removeChild(e)}),2e3))};window.addEventListener("message",l),window.addEventListener("beforeunload",(()=>{chrome.runtime.sendMessage({main_op:"emit-perf-data",data:{requestId:a}})}))}async function P(a,n,i){h();const d=`req_${Date.now()}_${Math.random().toString(36).substring(2,8)}`;m(d,i);const l=s({requestId:d});g.set(d,l),l.mark(c.AWPP_CONTEXT_MENU_CLICKED,{url:n.url}),e.event(e.e.CONTEXT_MENU_ADD_WEB_PAGE_TO_PROJECT,{url:n.url,CONTEXT:i});const u={env:o.getEnv(),locale:t.getItem("appLocale")||chrome.i18n.getMessage("@@ui_locale"),requestId:d,tabId:n.id,context:i};try{const e=await Promise.race([chrome.scripting.executeScript({target:{tabId:n.id},func:I,args:[u]}),new Promise(((e,t)=>{setTimeout((()=>{t(new Error("AddWebpageToProject Extension iframe script execution timeout"))}),1e4)}))]);if(!e||0===e.length)throw new Error("Script execution returned no results")}catch(e){let t=e?.message;chrome.runtime.lastError&&(t=chrome.runtime.lastError.message),l.mark(c.AWPP_EXTENSION_IFRAME_SCRIPT_EXECUTION_FAILED,{error:t}),r.error({message:"Error in executing AddWebpageToProject Extension iframe script",error:t,requestId:d})}finally{l.mark(c.AWPP_EXTENSION_IFRAME_SCRIPT_EXECUTION_COMPLETED)}}function w(e){P(0,{id:e.tabId,url:e.url},e.context)}chrome.runtime.onMessage.addListener(((e,t,o)=>{const a=e?.main_op;switch(a){case"openCollectionTab":!function(e,t,o){try{const{collectionUrl:a,requestId:n}=e.data,s=new URL(a);chrome.tabs.query({url:`${s.origin}${s.pathname}*`},(t=>{let s=!1;t?.length>0?chrome.tabs.update(t[0].id,{active:!0,url:a}):(s=!0,chrome.tabs.create({url:a})),o({success:!0,closeDialog:e.data.closeDialog}),r.info({message:"AddWebpageToProject Open project url "+(s?"in new tab":"in existing tab"),requestId:n})})),chrome.scripting.executeScript({target:{tabId:t?.tab?.id},func:async()=>await(window.extractWebpageHTML?.())})}catch(t){r.error({message:"Error in opening collection tab",error:t?.message,...e.data})}}(e,t,o);break;case"kw-perf-mark":!function(e){const t=e?.data?.requestId,r=g.get(t);r&&r.mark(e.data.name,e.data.metadata)}(e);break;case"emit-perf-data":!function(e){const t=e?.data?.requestId,o=g.get(t);if(o){const e=o.getPerfTimings();r.info({message:"AddWebpageToProject_PerfTimings",perfTimings:e}),g.delete(t)}}(e)}return!0}));export{E as isAddWebpageToProjectEnabled,_ as toggleAddWebpageToProjectContextMenu,P as handleAddWebpageToProjectContextMenu,w as handleAddWebpageToProjectAction,b as checkForBlockedDomain};