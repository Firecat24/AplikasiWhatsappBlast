/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
let initDcLocalStoragePromise,scrollY;function isGoogleQuery(e){if(!e)return!1;try{const t=new URL(e);if(t.host.startsWith("www.google.")||t.host.startsWith("www.bing."))return!0}catch(e){return!1}return!1}function isSupportedBrowserVersion(){const e=navigator.userAgent.match(/Chrome\/([0-9]+)/);return!(e&&e.length>=2)||+e[1]>=SETTINGS.SUPPORTED_VERSION}function checkForThirdPartyCookiesStatus(e){const t=document.createElement("iframe");t.id="third-party-cookies-checker",t.style.display="none",t.src=chrome.runtime.getURL("browser/js/check-cookies.html");const o=(r,n,a)=>{"thirdPartyCookiesChecked"===r.content_op&&(t.remove(),chrome.runtime.onMessage.removeListener(o),e&&e(r.status))};chrome.runtime.onMessage.addListener(o),document.documentElement.appendChild(t)}const launchIFrame=e=>new Promise((t=>{if(!e)return void t("");let o=document.getElementById("contentIframe");o&&o.remove();let r=document.createElement("iframe");r.id="contentIframe",r.style.width="0px",r.style.height="0px",r.style.border="none",r.style.position="absolute",r.style.visibility="hidden",document.body.appendChild(r),fetch(e,{method:"HEAD"}).then((t=>{let o=t.headers.get("x-frame-options"),n=t.headers.get("content-security-policy");if(o||n&&n.includes("frame-ancestors"))throw new Error("Iframe blocked due to X-Frame-Options or CSP frame-ancestors policy.");r.src=e})).catch((t=>{chrome.runtime.sendMessage({main_op:"log-error",log:{message:"Iframe blocked due to CORS, CSP, or X-Frame-Options",url:e,error:t.toString()}})})),r.onload=function(){try{r.contentWindow.document;chrome.runtime.sendMessage({main_op:"log-info",log:{message:"Successfully launched an iframe on URL change",url:e}}),t(r)}catch(o){chrome.runtime.sendMessage({main_op:"log-error",log:{message:"Iframe loaded but access denied (Possible CORS restriction)",url:e,error:o.toString()}}),t(null)}},r.onerror=function(){chrome.runtime.sendMessage({main_op:"log-error",log:{message:"Failed to load iframe URL (possible network error)",url:e}}),t(null)}})),functionThrottler=(e,t)=>{let o=0;return function(...r){const n=Date.now();n-o>=t&&(o=n,e.apply(this,r))}},renderGenAIWebpageFAB=()=>{$(document).ready((()=>{!async function(){const e=window.scrollY>1&&null!=scrollY&&window.scrollY!==scrollY,t=await GenAIWebpageEligibilityService.shouldShowTouchpoints(),o=!e&&t;if(window.dcLocalStorage.getItem("genAiWebpageCoachmarkData")){const e=new FABManager;o?(await initDcLocalStoragePromise,e.renderFAB({enableHoveredState:!window.dcLocalStorage.getItem("fabHoveredStateShown")}),window.dcLocalStorage.setItem("fabHoveredStateShown",!0)):e.removeFAB()}e&&launchIFrame(document.URL),chrome.runtime.sendMessage({main_op:"log-info",log:{message:e?"URL changed due to page scroll":"URL changed due to page navigation",url:document.URL}}),chrome.runtime.sendMessage({type:"send_to_sidepanel",main_op:"page_switched",qualified:t,isScrolled:e,url:document.URL}),scrollY=window.scrollY}()}))},throttledRenderGenAIWebpageFAB=functionThrottler(renderGenAIWebpageFAB,300),initDcLocalStorageHelper=async()=>{const e=chrome.runtime.getURL("./common/local-storage.js"),{dcLocalStorage:t}=await import(e);return await t.init(),t},initDcLocalStorage=async()=>(initDcLocalStoragePromise||(initDcLocalStoragePromise=initDcLocalStorageHelper()),window.dcLocalStorage||(window.dcLocalStorage=await initDcLocalStoragePromise),window.dcLocalStorage);function getCleanedHtml(){try{const e=document.cloneNode(!0),t=new Set(["script","style","iframe","head","meta","noscript","template","link","colgroup","col","track","param","source","slot","base","map","embed","area","applet"]),o=new Set(["href","title","src","id","alt"]);t.forEach((t=>{e.querySelectorAll(t).forEach((e=>e.remove()))}));const r=e.createTreeWalker(e.documentElement,NodeFilter.SHOW_ELEMENT,null);for(;r.nextNode();){const e=r.currentNode;[...e?.attributes||[]].forEach((t=>{o.has(t.name)||e.removeAttribute(t.name)}))}return e.documentElement.outerHTML}catch(e){return document.documentElement.outerHTML}}function PromiseTimeout(e,t={}){const o=new Promise((e=>{const o=setTimeout((()=>{clearTimeout(o),e(t?.defaultVal)}),t?.timeout)}));return Promise.race([e,o])}initDcLocalStorage(),chrome.runtime.onMessage.addListener(((e,t,o)=>{if("removeActionableCoachmark"===e.type){(new ActionableCoachmark).remove()}return(async()=>{switch(e.main_op){case"getHtmlContent":o({htmlContent:getCleanedHtml(),url:document.URL,initialQuestion:initialQuestion,disqualified:!await GenAIWebpageEligibilityService.isCurrentWebPageReadable(),textContent:document.documentElement.innerText});break;case"highlightText":(new AttributionManager).highlightText(e);break;case"removeHighlights":(new AttributionManager).removeHighlights();break;case"shouldDisableGenAIForWebPagesTPs":o(await GenAIWebpageEligibilityService.shouldDisableTouchpoints());break;case"shouldShowGenAIForWebPagesTPs":o(await GenAIWebpageEligibilityService.shouldShowTouchpoints());break;case"rerunGenAiWebpage":GenAIWebpageEligibilityService.reset(),await initDcLocalStorage(),throttledRenderGenAIWebpageFAB()}})(),!0}));